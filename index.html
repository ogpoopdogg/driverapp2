<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>E&C Dispatch | Driver Portal</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --accent: #ffcc00; --queue-orange: #ff9800; --active-green: #4caf50;
      --review-blue: #2196f3; --decline-red: #f44336; --update-blue: #00d4ff;
      --bg-core: #050505; --bg-panel: #1e1e1e; --bg-header: #0a0a0a; --bg-input: #222;
      --text-main: #ffffff; --text-sec: #bbb; --border-soft: #333; --card-bg: #1e1e1e;
    }
    [data-theme="light"] {
      --accent: #d6a400; --bg-core: #f0f2f5; --bg-panel: #ffffff; --bg-header: #ffffff;
      --bg-input: #eef; --text-main: #111111; --text-sec: #555555; --border-soft: #ccc; --card-bg: #ffffff;
    }
    [data-theme="light"] .light-inv { color: #000 !important; border-color: #000 !important; text-shadow: none !important; }

    * { box-sizing: border-box; }
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg-core); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; }
    
    /* Utility Classes */
    .flex { display: flex; } .col { flex-direction: column; } .row { flex-direction: row; }
    .center { align-items: center; justify-content: center; } .aic { align-items: center; } .jcw { justify-content: space-between; }
    .abs { position: absolute; } .rel { position: relative; } .d-none { display: none !important; }
    .bold { font-weight: 700; } .black { font-weight: 900; } .uc { text-transform: uppercase; }
    .w-full { width: 100%; } .h-full { height: 100%; } .pointer { cursor: pointer; }

    /* Component Styles */
    #map-container { height: 0; width: 0; opacity: 0; pointer-events: none; }
    #mini-map-list { position: absolute; inset: 0; padding: 20px 15px 100px; overflow-y: auto; z-index: 10; background: var(--bg-core); }
    
    .mini-list-item { font-size: 16px; color: var(--text-main); margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: var(--bg-panel); border: 1px solid var(--border-soft); border-radius: 12px; transition: 0.2s; }
    .mini-list-item:active { transform: scale(0.98); background: var(--bg-input); }
    .mini-num { font-weight: 900; background: #fff; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .mini-address { font-size: 13px; color: #fff; text-align: right; margin-left: 10px; }
    
    .list-update-badge { background: var(--update-blue); color: #000; font-size: 9px; padding: 3px 6px; border-radius: 4px; margin-right: 8px; animation: pulse-update 0.5s infinite alternate; box-shadow: 0 0 5px var(--update-blue); }
    .mini-flash { animation: mini-pulse 1s infinite alternate; border: 1px solid var(--update-blue); }
    @keyframes mini-pulse { from { box-shadow: 0 0 2px var(--update-blue); } to { box-shadow: 0 0 10px var(--update-blue); } }
    
    /* Live Feed & Cards */
    #live-feed { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; padding: 20px; flex-direction: column; overflow-y: auto; align-items: center; }
    #live-feed.overlay-active { display: flex; }
    #live-feed::before { content: ''; flex: 1 1 auto; }
    
    .active-card { background: var(--card-bg); padding: 15px; border-radius: 16px; border: 1px solid var(--border-soft); width: 100%; max-width: 600px; display: flex; flex-direction: column; animation: slideUp 0.3s ease; box-shadow: 0 -10px 40px rgba(0,0,0,0.6); margin-bottom: 30px; flex-shrink: 0; }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Buttons & Inputs */
    #route-toggle-btn { position: absolute; bottom: 30px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #222; color: #fff; border: 2px solid var(--accent); z-index: 100; display: flex; align-items: center; justify-content: center; transition: 0.3s; box-shadow: 0 6px 20px rgba(0,0,0,0.6); }
    .route-glow-update { animation: update-pulse 2s infinite ease-in-out !important; border-color: #ff9800 !important; background: linear-gradient(135deg, #222, #530) !important; }
    @keyframes update-pulse { 0%, 100% { box-shadow: 0 0 5px rgba(255,152,0,0.2); } 50% { box-shadow: 0 0 20px rgba(255,152,0,0.6); } }

    .header-logo { height: 28px; width: auto; margin-right: 12px; filter: drop-shadow(0 0 5px var(--accent)); animation: logo-glow 2s infinite alternate; cursor: pointer; }
    @keyframes logo-glow { to { filter: drop-shadow(0 0 8px var(--accent)); transform: scale(1.05); } }
    
    .field-highlight { color: var(--update-blue) !important; text-shadow: 0 0 10px rgba(0,212,255,0.6); font-weight: bold; animation: field-pulse 1s infinite alternate; }
    .has-update { border: 2px solid var(--update-blue) !important; animation: update-glow 1.5s infinite alternate !important; }
    @keyframes update-glow { from { box-shadow: 0 0 5px var(--update-blue); } to { box-shadow: 0 0 15px var(--update-blue); } }
    @keyframes field-pulse { to { opacity: 1; transform: scale(1.05); } }

    #login-overlay { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
    .login-box { width: 100%; max-width: 350px; background: var(--bg-panel); padding: 30px; border-radius: 16px; border: 1px solid var(--border-soft); text-align: center; }
    .login-input { width: 100%; padding: 15px; margin: 10px 0; background: var(--bg-input); border: 1px solid var(--border-soft); color: var(--text-main); border-radius: 8px; font-size: 16px; outline: none; }
    .login-submit { width: 100%; padding: 15px; margin-top: 15px; background: var(--accent); border: none; font-weight: 900; border-radius: 8px; cursor: pointer; }

    header { padding: 12px 16px; background: var(--bg-header); border-bottom: 2px solid var(--accent); display: flex; justify-content: space-between; align-items: center; z-index: 20; }
    .done-btn { width: 100%; padding: 12px 0; border-radius: 6px; color: #fff; font-weight: 800; background: linear-gradient(135deg, var(--active-green), #388e3c); font-size: 14px; border:none; cursor:pointer; flex: 1; }
    .info-btn { width: 100%; background: transparent; color: var(--review-blue); border: 1px solid var(--review-blue); padding: 8px 0; font-size: 11px; font-weight: 800; border-radius: 6px; cursor: pointer; margin-bottom: 6px; }
    
    .card-label { color: var(--accent); font-size: 9px; font-weight: 800; text-transform: uppercase; margin: 4px 0 1px; opacity: 0.8; }
    .city-tag { font-size: 10px; background: var(--bg-input); padding: 2px 8px; border-radius: 20px; font-weight: 700; border: 1px solid var(--border-soft); }
    .pickup-value { font-size: 15px; font-weight: 700; color: var(--text-main); text-transform: uppercase; margin-bottom: 2px; }
    .drop-value { font-size: 13px; font-weight: 500; color: var(--text-sec); text-transform: uppercase; }
    
    .new-job-highlight { border: 2px solid var(--active-green) !important; background: linear-gradient(135deg, #1e251e 0%, #1a1a1a 100%) !important; }
    .arrival-highlight .done-btn { animation: arrival-glow 0.8s infinite alternate !important; border: 3px solid #fff !important; box-shadow: 0 0 25px var(--active-green) !important; }
    @keyframes arrival-glow { to { transform: scale(1.08); filter: brightness(1.3); } }
    .heavy-word { display: inline-block; animation: heavy-flash 0.8s infinite; font-weight: 900; text-transform: uppercase; color: #ff3333; }
    @keyframes heavy-flash { 50% { color: #ff0000; transform: scale(1.1); } }
    
    /* Helpers for generated content */
    .g-badge { background: #fff; color: #000; padding: 2px 6px; border-radius: 50%; font-size: 14px; border: 2px solid; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 6px; font-weight: 900; }
    .g-tag { color: #000; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 900; }
    .g-note { text-align: center; width: 100%; margin-top: 10px; color: #ddd; font-size: 12px; font-style: italic; }
  </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color:var(--accent); margin-top:0; font-weight:800; letter-spacing:1px;">E&C PORTAL</h2>
        <input type="email" id="login-user" class="login-input" placeholder="Email (DriverName@ec.com)" autofocus>
        <input type="password" id="login-pin" class="login-input" placeholder="Password">
        <button class="login-submit" onclick="attemptLogin()">Enter</button>
    </div>
</div>

<header>
  <h1 id="header-name" style="margin:0; color:var(--accent); font-size:18px; font-weight:800; display:flex; align-items:center;">
    <img src="icon-512.png" class="header-logo" alt="Logo" onclick="toggleTheme()">
    E&C PORTAL
  </h1>
  <button id="install-btn" class="install-btn d-none" onclick="installPWA()" style="background:#2196f3; color:#fff; border-radius:20px; font-size:11px; font-weight:800; border:none; padding:6px 12px;">Install App</button>
  <div id="clock" class="light-inv" style="font-size:14px; color:var(--accent); font-weight:600;"></div>
</header>

<div id="map-container"><div id="map"></div></div>

<div id="main-container" class="flex col flex-1 rel h-full w-full overflow-hidden">
  <div id="mini-map-list"></div>
  <div id="live-feed" onclick="if(event.target === this) closeJobCard()"></div>
  
  <button id="route-toggle-btn" onclick="openExternalRoute()">
    <svg viewBox="0 0 24 24" style="width:30px; height:30px; fill:#fff;"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
  </button>

  <div id="history-sidebar" class="d-none">
    <div id="queue-log"></div><div id="recent-log"></div>
    <button id="multi-route-btn" onclick="routeOptimized()" class="d-none">ROUTE NAV</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDltbEbiqlyQjyaGth0AzIkfLpOYr96YeQ&libraries=places,geometry&callback=initMap" async defer></script>

<script>
  const savedTheme = localStorage.getItem('ec_theme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);

  firebase.initializeApp({
    apiKey: "AIzaSyAKmgoXA4m3cRTmxJq4aUyva5SVvFbTNqg",
    authDomain: "eandccourier-36fcc.firebaseapp.com",
    databaseURL: "https://eandccourier-36fcc-default-rtdb.firebaseio.com",
    projectId: "eandccourier-36fcc",
    messagingSenderId: "931221081541",
    appId: "1:1067680083511:android:22d1eb3757302492bd19b2",
  }); 

  const db = firebase.database();
  let messaging = null;
  try { if (firebase.messaging.isSupported()) messaging = firebase.messaging(); } catch(e) {}

  let currentDriver = localStorage.getItem('ec_driver_name');
  let observer = null, fieldSnapshots = {}, pendingAlerts = {}, selfEdited = new Set();
  let globalJobs = {}, map, directionsService, directionsRenderer, driverMarker, mapMarkers = [], mapLabels = [], mapPolyline, isNavigating = false, autoCenter = true;
  let lastGps = null, optimizedOrder = [], lastPendingCount = 0, lastAnnouncedId = null, isFirstLoad = true, hasRoutedWithGps = false;
  let lastGpsUpdate = 0, wakeLock = null;
  const gpsInterval = 30000, previouslyKnown = JSON.parse(localStorage.getItem('ec_known_jobs') || '[]');

  const darkMapStyles = [{ elementType: "geometry", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] }, { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] }, { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] }, { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] }];
  
  function toggleTheme() {
    const isLight = document.body.getAttribute('data-theme') === 'light';
    const newTheme = isLight ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('ec_theme', newTheme);
    if(map) map.setOptions({ styles: newTheme === 'light' ? [] : darkMapStyles });
  }
  
  function initMap() {
    const isLight = document.body.getAttribute('data-theme') === 'light';
    map = new google.maps.Map(document.getElementById("map"), { zoom: 13, center: { lat: 49.8485, lng: -99.9501 }, disableDefaultUI: true, styles: isLight ? [] : darkMapStyles });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true, preserveViewport: true, polylineOptions: { strokeColor: "#00d4ff", strokeWeight: 6, strokeOpacity: 0.8 } });
    driverMarker = new google.maps.Marker({ map: map, icon: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale: 6, fillColor: "#4285F4", fillOpacity: 1, strokeWeight: 2, strokeColor: "white", rotation: 0 }, zIndex: 999 });
    map.addListener('dragstart', () => { autoCenter = false; });
  }

  function enableAutoCenter() {
      autoCenter = true;
      if(lastGps) { map.setCenter(lastGps); map.setZoom(17); map.setTilt(45); }
  }

  function openExternalRoute() {
    document.getElementById('route-toggle-btn').classList.remove('route-glow-update');
    document.querySelectorAll('.mini-flash').forEach(el => el.classList.remove('mini-flash')); 
    if(optimizedOrder.length === 0) return alert("No stops to route.");
    
    const origin = lastGps ? `${lastGps.lat},${lastGps.lng}` : "1604 Moreland Ave, Brandon MB";
    const seenLocs = new Set();
    const waypoints = optimizedOrder.map(id => {
        const job = globalJobs[id]; if(!job) return "";
        const addr = job.jobType === 'pickup' ? job.pickup_location : job.destination;
        const key = `${job.jobType === 'pickup' ? job.name : job.delivery_name} ${addr}, ${job.city || "Brandon"}`;
        if(seenLocs.has(key)) return ""; seenLocs.add(key);
        return encodeURIComponent(key);
    }).filter(w => w !== "").join("|");

    updateRoute();
    const dest = encodeURIComponent("1604 Moreland Ave, Brandon MB");
    const ua = navigator.userAgent;
    if (/android/i.test(ua)) window.location.href = `intent://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${dest}&waypoints=${waypoints}&travelmode=driving#Intent;scheme=https;package=com.google.android.apps.maps;end`;
    else if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) window.location.href = `comgooglemapsurl://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${dest}&waypoints=${waypoints}&travelmode=driving`;
    else window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${dest}&waypoints=${waypoints}&travelmode=driving`, '_blank');
  }

  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }
  
  function broadcastLocation() {
    if(!currentDriver || !lastGps || Date.now() - lastGpsUpdate < 2000) return;
    db.ref(`driver_locations/${currentDriver}`).update({ lat: lastGps.lat, lng: lastGps.lng, last_seen: Date.now(), gps_timestamp: Date.now() });
    lastGpsUpdate = Date.now();
  }
  setInterval(broadcastLocation, gpsInterval);
  document.addEventListener('click', broadcastLocation);

  async function startContinuousTracking() {
    if ("Notification" in window && messaging) {
      Notification.requestPermission().then(p => {
        if (p === 'granted') navigator.serviceWorker.ready.then(reg => messaging.getToken({ serviceWorkerRegistration: reg, vapidKey: "BA1S09dDHyCTLXZfDGckfFdg0kvCyezfgst5eMhe0TnL03C7eHn3yogeC_u20knFpMxFNsHGZHsDjNp0RXjKHfI" }).then(t => t && db.ref(`driver_locations/${currentDriver}/fcm_token`).set(t)));
      });
    }
    if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
    if (!navigator.geolocation) return;
    navigator.geolocation.watchPosition((pos) => {
      lastGps = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      const latLng = new google.maps.LatLng(lastGps.lat, lastGps.lng);
      Object.keys(globalJobs).forEach(jid => {
        const job = globalJobs[jid];
        if (job.status === 'pending' && job.lat && getDistance(lastGps.lat, lastGps.lng, job.lat, job.lng) < 50) {
            document.getElementById('card-' + jid)?.classList.add('arrival-highlight');
            document.getElementById('mini-' + jid)?.classList.add('arrival-green-tint');
        }
      });
      if(driverMarker) { driverMarker.setPosition(latLng); if(pos.coords.heading) driverMarker.setIcon({...driverMarker.getIcon(), rotation: pos.coords.heading}); }
      if(autoCenter && map) { map.setCenter(latLng); map.setHeading(pos.coords.heading || 0); }
      if (!hasRoutedWithGps && Object.keys(globalJobs).length > 0) { hasRoutedWithGps = true; updateRoute(); }
      if (lastGpsUpdate === 0) broadcastLocation();
    }, (e) => console.warn(e), { enableHighAccuracy: true, maximumAge: 0 });
  }

  async function updateRoute() {
    const jobs = Object.values(globalJobs).filter(j => j.status === 'pending' && j.assigned_to === currentDriver);
    if(mapPolyline) mapPolyline.setMap(null);
    mapMarkers.forEach(m => m.setMap(null)); mapMarkers = [];
    mapLabels.forEach(l => l.close()); mapLabels = [];
    optimizedOrder = []; 
    if(jobs.length === 0) return document.getElementById('mini-map-list').style.display = 'none';

    const groupMap = new Map(), groups = [];
    jobs.forEach(j => {
        const key = `${j.jobType==='pickup'?j.name:j.delivery_name}|${j.jobType==='pickup'?j.pickup_location:j.destination}|${j.city||"Brandon"}`.toLowerCase();
        if(!groupMap.has(key)) {
            const g = { key, masterJob: j, jobs: [], addrString: `${j.jobType==='pickup'?j.name:j.delivery_name} ${j.jobType==='pickup'?j.pickup_location:j.destination}, ${j.city||"Brandon"}` };
            groupMap.set(key, g); groups.push(g);
        }
        groupMap.get(key).jobs.push(j);
    });

    try {
        const res = await fetch("https://routes.googleapis.com/directions/v2:computeRoutes", {
            method: "POST", headers: { "Content-Type": "application/json", "X-Goog-Api-Key": "AIzaSyDltbEbiqlyQjyaGth0AzIkfLpOYr96YeQ", "X-Goog-FieldMask": "routes.duration,routes.optimizedIntermediateWaypointIndex,routes.polyline.encodedPolyline,routes.legs" },
            body: JSON.stringify({ origin: lastGps ? { location: { latLng: { latitude: lastGps.lat, longitude: lastGps.lng } } } : { address: "1604 Moreland Ave, Brandon MB" }, destination: { address: "1604 Moreland Ave, Brandon MB" }, intermediates: groups.map(g => ({ address: g.addrString })), travelMode: "DRIVE", optimizeWaypointOrder: groups.length > 1 })
        });
        const result = await res.json();
        
        if (result.routes && result.routes[0]) {
            if(result.routes[0].polyline) {
                mapPolyline = new google.maps.Polyline({ path: google.maps.geometry.encoding.decodePath(result.routes[0].polyline.encodedPolyline), geodesic: true, strokeColor: "#00d4ff", strokeOpacity: 0.8, strokeWeight: 6, map: map });
                const dur = parseInt(result.routes[0].duration||0);
                const order = result.routes[0].optimizedIntermediateWaypointIndex;
                const orderedGroups = order ? order.map(i => groups[i]) : groups;
                orderedGroups.forEach(g => g.jobs.forEach(j => optimizedOrder.push(Object.keys(globalJobs).find(k => globalJobs[k] === j))));
                
                db.ref(`driver_locations/${currentDriver}`).update({ active_route: result.routes[0].polyline.encodedPolyline, route_string: orderedGroups.map((g,i)=>`${i+1}. ${g.masterJob.jobType==='pickup'?g.masterJob.name:g.masterJob.delivery_name}`).join(" | "), route_order: optimizedOrder, total_duration: dur>3600?`${Math.floor(dur/3600)}h ${Math.floor((dur%3600)/60)}m`:`${Math.floor(dur/60)}m`, route_timestamp: Date.now() });

                let listHtml = "", legs = result.routes[0].legs;
                orderedGroups.forEach((g, i) => {
                    if(i < legs.length && legs[i].endLocation) {
                        const loc = legs[i].endLocation.latLng;
                        g.jobs.forEach(gj => { gj.lat = loc.latitude; gj.lng = loc.longitude; db.ref(gj.jobType==='pickup'?'pickups':'dropoffs').child(Object.keys(globalJobs).find(k=>globalJobs[k]===gj)).update({lat:loc.latitude, lng:loc.longitude}); });
                        
                        const color = g.masterJob.jobType==='pickup' ? "#FE9800" : "#4CAF50";
                        mapMarkers.push(new google.maps.Marker({ position: loc, map: map, label: { text: (i+1).toString(), color: "white", fontWeight: "bold" }, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 14, fillColor: color, fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }, zIndex: 100 }));
                        const info = new google.maps.InfoWindow({ content: `<div>${g.masterJob.jobType==='pickup'?g.masterJob.name:g.masterJob.delivery_name}</div>`, disableAutoPan: true, position: loc, pixelOffset: new google.maps.Size(0, -25) });
                        info.open(map); mapLabels.push(info);

                        const gIds = g.jobs.map(j => Object.keys(globalJobs).find(k => globalJobs[k] === j));
                        const isNew = gIds.some(id => !previouslyKnown.includes(id)), hasUpd = gIds.some(id => pendingAlerts[id]?.length > 0);
                        listHtml += `<div class="mini-list-item ${hasUpd||isNew?'mini-flash':''}" onclick="showJobGroup('${gIds.join(',')}')" id="mini-${gIds[0]}">${hasUpd?'<div class="list-update-badge">NEW INFO</div>':''}<div class="mini-num" style="background:${color};color:#000;">${i+1}</div><div style="flex:1;overflow:hidden;"><div class="bold" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${g.masterJob.jobType==='pickup'?g.masterJob.name:g.masterJob.delivery_name} ${g.jobs.length>1?`<span style="background:var(--accent);color:#000;font-size:10px;padding:1px 6px;border-radius:8px;">${g.jobs.length} ORDERS</span>`:""}</div><div style="border:1px solid #333;border-radius:6px;padding:6px;margin-top:5px;background:rgba(0,0,0,0.2);"><div class="mini-address">${g.masterJob.jobType==='pickup'?g.masterJob.pickup_location:g.masterJob.destination}</div><div style="font-size:13px;color:#888;">${g.masterJob.city||"Brandon"}</div></div></div></div>`;
                    }
                });
                document.getElementById('mini-map-list').innerHTML = listHtml;
                document.getElementById('mini-map-list').style.display = 'block';
                isNavigating = true; renderUnifiedFeed(); localStorage.setItem('ec_known_jobs', JSON.stringify(Object.keys(globalJobs)));
            }
        }
    } catch(e) { console.error(e); }
  }

  firebase.auth().onAuthStateChanged((user) => {
    if (user && user.email) {
      const raw = user.email.split('@')[0]; currentDriver = raw.charAt(0).toUpperCase() + raw.slice(1);
      localStorage.setItem('ec_driver_name', currentDriver);
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('header-name').innerHTML = `<img src="icon-512.png" class="header-logo" onclick="toggleTheme()"><span onclick="location.reload()" style="cursor:pointer; font-size:14px; color:#39FF14; font-weight:900; border:1px solid #39FF14; padding:2px 8px; border-radius:4px; margin-right:8px;">${currentDriver}</span><span id="stop-counter" class="light-inv" style="background:rgba(0,212,255,0.1); color:var(--update-blue); border:1px solid var(--update-blue); padding:4px 10px; border-radius:6px; font-size:12px; font-weight:700;">0 STOPS</span>`;
      startContinuousTracking(); setupIntersectionObserver(); startDataListeners(); mergeAndRender(); 
    } else document.getElementById('login-overlay').style.display = 'flex';
  });

  function setupIntersectionObserver() {
    observer = new IntersectionObserver((entries) => {
      entries.forEach(e => { if (e.isIntersecting) {
          const id = e.target.id.replace('card-', ''), job = globalJobs[id];
          if(job) db.ref(`${job.jobType==='pickup'?'pickups':'dropoffs'}/${id}/seen_by/${currentDriver}`).once('value', s => {});
      }});
    }, { threshold: 0.5 });
  }

  function markAsSeenPersistent(id, refPath) {
    db.ref(`${refPath}/${id}/seen_by/${currentDriver}`).set(true).then(() => { document.getElementById(`card-${id}`)?.classList.remove('new-job-highlight'); updateNewStopsCountUI(); });
  }

  function updateNewStopsCountUI() {
    const c = document.querySelectorAll('.new-job-highlight').length, b = document.getElementById('new-stops-badge');
    if (b) { b.innerText = `${c} NEW`; b.style.display = c > 0 ? 'inline-block' : 'none'; }
  }

  function attemptLogin() {
    const e = document.getElementById('login-user').value.trim(), p = document.getElementById('login-pin').value.trim();
    if (e && p) firebase.auth().signInWithEmailAndPassword(e, p).catch(err => alert("Login Failed: " + err.message));
  }
  document.addEventListener('keypress', (e) => { if (e.key === 'Enter' && document.getElementById('login-overlay').style.display !== 'none') attemptLogin(); });

  function dndJob(id, notes) {
    const job = globalJobs[id]; if(!job) return;
    const r = prompt(job.jobType==='pickup' ? "Reason for DNP:" : "Reason for DND:");
    if (r && r.trim()) {
      const n = `${job.jobType==='pickup'?"DNP":"DND"} (${currentDriver}): ${r}`, all = notes ? `${notes} | ${n}` : n;
      db.ref(job.jobType==='pickup'?'pickups':'dropoffs').child(id).update({ assigned_to: "", status: "pending", other_info: all }).then(closeJobCard);
      if (job.customer_email) fetch("https://script.google.com/macros/s/AKfycbyQDC4eq3YiiDLuY42Y7rBpWa1FBkPTaCUMQJTSw8qAEzW5sfBA4hR4WNNwzdxMFLij/exec", { method: "POST", mode: "no-cors", body: JSON.stringify({ email: job.customer_email, notes: n, type: job.jobType }) });
    }
  }

  function enterNoteEdit(id, notes) {
    document.getElementById(`note-display-${id}`).innerHTML = `<textarea id="edit-input-${id}" class="login-input" style="color:#fff;" onclick="event.stopPropagation()">${notes.replace(/\\'/g, "'")}</textarea><button class="g-tag" style="background:var(--active-green);color:#fff;border:none;margin-top:8px;cursor:pointer;" onclick="event.stopPropagation();saveNoteEdit('${id}')">SAVE</button>`;
  }
  function saveNoteEdit(id) {
    const v = document.getElementById('edit-input-' + id).value; selfEdited.add(`${id}_notes`);
    db.ref(globalJobs[id].jobType==='pickup'?'pickups':'dropoffs').child(id).update({ other_info: `${v} (Edited by ${currentDriver})` });
  }

  function toggleDriverNoteEdit(e, id) {
    e.stopPropagation(); const c = document.getElementById(`driver-note-display-${id}`);
    if(c.innerHTML.trim()) c.innerHTML = "";
    else {
        c.innerHTML = `<div class="abs" style="bottom:0;left:0;width:100%;background:#151515;padding:15px;border-top:2px solid var(--accent);z-index:10000;box-shadow:0 -5px 30px rgba(0,0,0,0.9);"><div class="sb row mb-1"><span style="color:var(--accent);" class="black">DRIVER NOTE</span></div><div class="rel"><textarea id="driver-edit-input-${id}" class="login-input" style="height:100px;border-color:var(--accent);" onclick="event.stopPropagation()"></textarea><button onclick="toggleDriverNoteEdit(event,'${id}')" class="abs" style="bottom:15px;right:10px;background:red;color:#fff;border:1px solid #fff;border-radius:20px;font-size:11px;padding:6px 12px;font-weight:800;">CANCEL</button></div><button class="w-full" style="padding:12px;background:var(--active-green);color:#fff;border:none;font-weight:bold;border-radius:4px;" onclick="event.stopPropagation();saveDriverNote('${id}')">SEND NOTE</button></div>`;
        setTimeout(() => document.getElementById(`driver-edit-input-${id}`).focus(), 100);
    }
  }
  function saveDriverNote(id) {
    const v = document.getElementById(`driver-edit-input-${id}`).value, p = globalJobs[id].jobType==='pickup'?'pickups':'dropoffs';
    db.ref(p).child(id).child("other_info").once("value", s => {
      selfEdited.add(`${id}_notes`);
      db.ref(p).child(id).update({ other_info: (s.val() ? `${s.val()} | ` : "") + `Driver Note (${currentDriver}): ${v}` }).then(closeJobCard);
    });
  }

  function enterPoEdit(e, id, v) { e.stopPropagation(); document.getElementById(`po-container-${id}`).innerHTML = `<div class="row" style="gap:5px;justify-content:flex-end;margin-top:5px;"><input type="text" id="po-input-${id}" class="login-input" style="width:120px;padding:6px;margin:0;font-size:13px;border-color:var(--accent);" value="${v.replace(/"/g, "")}" onclick="event.stopPropagation()"><button class="g-tag" style="background:var(--active-green);color:#fff;border:none;cursor:pointer;" onclick="savePoEdit(event,'${id}')">SAVE</button><button class="g-tag" style="background:#555;color:#fff;border:none;cursor:pointer;" onclick="event.stopPropagation();document.getElementById('po-container-${id}').innerHTML='PO: <span style=\\'color:var(--accent);\\'>${v}</span>'">X</button></div>`; }
  function savePoEdit(e, id) { e.stopPropagation(); selfEdited.add(`${id}_po`); db.ref(globalJobs[id].jobType==='pickup'?'pickups':'dropoffs').child(id).update({ po_number: document.getElementById(`po-input-${id}`).value }); }

  function routeOptimized() { enableAutoCenter(); }
  
  function showJobGroup(ids) {
      document.querySelectorAll('.active-card').forEach(c => c.style.display = 'none');
      ids.split(',').forEach(id => { const c = document.getElementById('card-' + id); if(c) c.style.display = 'flex'; });
      const f = document.getElementById('live-feed'); f.classList.add('overlay-active'); f.scrollTop = 0;
  }
  
  function closeJobCard() {
      document.querySelectorAll('.active-card').forEach(c => {
        if(c.style.display !== 'none') {
             const id = c.id.replace('card-', '');
             if(c.classList.contains('new-job-highlight')) markAsSeenPersistent(id, globalJobs[id].jobType==='pickup'?'pickups':'dropoffs');
             if(pendingAlerts[id] || sessionStorage.getItem(`ack_update_${id}`) !== 'true') {
                  sessionStorage.setItem(`ack_update_${id}`, 'true'); delete pendingAlerts[id]; c.classList.remove('has-update'); document.getElementById(`badge-${id}`)?.remove();
             }
             if(!previouslyKnown.includes(id)) previouslyKnown.push(id);
             document.querySelectorAll(`#mini-${id}`).forEach(i => { i.classList.remove('mini-flash'); i.querySelector('.list-update-badge')?.remove(); });
        }
      });
      document.getElementById('live-feed').classList.remove('overlay-active');
  }

  function startDataListeners() {
    db.ref("pickups").orderByChild("assigned_to").equalTo(currentDriver).on("value", s => { pickupData = s.val() || {}; mergeAndRender(); });
    db.ref("dropoffs").orderByChild("assigned_to").equalTo(currentDriver).on("value", s => { dropoffData = s.val() || {}; mergeAndRender(); });
  }

  let pickupData = {}, dropoffData = {};
  function mergeAndRender() {
    if(!currentDriver) return;
    globalJobs = {};
    Object.entries(pickupData).forEach(([k, v]) => globalJobs[k] = { ...v, jobType: 'pickup' });
    Object.entries(dropoffData).forEach(([k, v]) => globalJobs[k] = { ...v, jobType: 'delivery' });
    
    const count = Object.values(globalJobs).filter(j => j.status === 'pending' && j.assigned_to === currentDriver).length;
    if (count !== lastPendingCount && !isFirstLoad) document.getElementById('route-toggle-btn').classList.add('route-glow-update');
    isFirstLoad = false; lastPendingCount = count; renderUnifiedFeed(); updateRoute();
  }

  function renderUnifiedFeed() {
    const feed = document.getElementById("live-feed"), qLog = document.getElementById("queue-log"), rLog = document.getElementById("recent-log"), ctr = document.getElementById("stop-counter");
    feed.innerHTML = "<div class='uc' style='width:100%;text-align:center;color:#555;font-size:10px;padding:10px;opacity:0.7;letter-spacing:1px;'>>> SWIPE RIGHT TO GO BACK</div>"; 
    rLog.innerHTML = ""; qLog.innerHTML = "";
    const today = new Date().setHours(0,0,0,0), uniqueStops = new Set();
    
    let entries = optimizedOrder.length ? [...optimizedOrder.map(id=>[id,globalJobs[id]]).filter(e=>e[1]), ...Object.entries(globalJobs).filter(([id])=>!optimizedOrder.includes(id))] : Object.entries(globalJobs);
    entries.sort((a,b)=>(a[1].timestamp||0)-(b[1].timestamp||0));

    let idx = 0, pCount = 0;
    entries.forEach(([id, p]) => {
      if (p.assigned_to !== currentDriver) return;
      if (p.status === 'completed' && (p.completed_at || 0) < today) return;

      if (fieldSnapshots[id]) {
          ['addr','dest','contact','dropName','po','notes','details','status','assigned'].forEach(k => {
             const val = k==='addr'?p.pickup_location:k==='dest'?p.destination:k==='contact'?p.name:k==='dropName'?p.delivery_name:k==='po'?p.po_number:k==='notes'?p.other_info:k==='details'?p.package_details:k==='status'?p.status:p.assigned_to;
             if(fieldSnapshots[id][k] !== val) {
                if(selfEdited.has(`${id}_${k}`)) selfEdited.delete(`${id}_${k}`);
                else { if(!pendingAlerts[id]) pendingAlerts[id] = []; if(!pendingAlerts[id].includes(k)) pendingAlerts[id].push(k); sessionStorage.removeItem(`ack_update_${id}`); }
             }
          });
      }
      fieldSnapshots[id] = { addr:p.pickup_location, dest:p.destination, contact:p.name, dropName:p.delivery_name, po:p.po_number, notes:p.other_info, details:p.package_details, status:p.status, assigned:p.assigned_to };

      const alerts = pendingAlerts[id] || [], needsAlert = alerts.length > 0 && !sessionStorage.getItem(`ack_update_${id}`);
      const isPick = p.jobType === 'pickup', color = isPick ? "#ff9800" : "#00ff41";
      const topL = isPick ? "PICKUP AT" : "DELIVER TO", topA = isPick ? p.pickup_location : p.destination, topC = isPick ? p.name : p.delivery_name;
      const botL = isPick ? "DELIVER TO" : "FROM", botA = isPick ? p.destination : p.pickup_location, botC = isPick ? p.delivery_name : p.name;
      
      const item = document.createElement("div"); 
      item.id = `mini-${id}`; item.className = `history-item ${needsAlert ? 'has-update' : ''}`;
      item.innerHTML = `<div style="background:${color};width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px;"></div><span style="font-size:12px;">${topC||'No Name'}</span><div style="font-weight:700;font-size:11px;color:#ccc;">${topA||"No Address"}</div><span style="font-size:10px;color:#777;font-style:italic;">${(p.package_details||'').replace(/\b(skid|pallet)\b/gi, '<span class="heavy-word">$&</span>')}</span>`;

      if (p.status === 'completed') { item.classList.add('done-slash'); item.onclick = () => { if(confirm("Restore?")) db.ref(isPick?'pickups':'dropoffs').child(id).update({status:'pending', completed_at:null}); }; rLog.appendChild(item); }
      else {
        pCount++; idx++; uniqueStops.add((isPick ? p.pickup_location : p.destination).trim());
        item.onclick = () => showJobGroup(id); qLog.appendChild(item);
        
        const card = document.createElement("div"); card.className = `active-card ${!p.seen_by?.[currentDriver] ? 'new-job-highlight' : ''} ${needsAlert ? 'has-update' : ''}`;
        card.style.display = 'none'; card.id = `card-${id}`;
        const edited = (p.other_info||"").includes("Edited by") || (p.other_info||"").includes("Note (");
        
        card.innerHTML = `
          <div class="row" style="gap:10px;">
            <div class="flex-1 min-w-0">
               <div class="row sb center" style="margin-bottom:4px; margin-right:30px;">
                  <div class="row center pointer" onclick="closeJobCard()">
                     <div class="g-badge" style="border-color:${color}; background:#fff;">${idx}</div>
                     <div class="g-tag" style="background:${color};">${isPick?"PICK UP":"DELIVERY"}</div>
                     ${needsAlert ? `<span id="badge-${id}" class="update-badge">NEW INFO</span>` : ''}
                  </div>
                  <a href="${getNavUrl((topC||'')+' '+topA, p.city)}" target="_blank"><div class="city-tag">${p.city||'??'}</div></a>
               </div>
               <div class="card-label">${topL}</div>
               <div class="black ${needsAlert&&alerts.includes('contact')?'field-highlight':''}" style="color:var(--queue-orange);font-size:16px;">${topC||'N/A'}</div>
               <a href="${getNavUrl((topC||'')+' '+topA, p.city)}" target="_blank" class="nav-link"><div class="pickup-value ${needsAlert&&alerts.includes('addr')?'field-highlight':''}">${topA}</div></a>
               <div style="background:rgba(255,255,255,0.05);padding:4px 6px;border-radius:4px;margin:6px 0;border-left:2px solid #555;">
                   <div class="bold uc ${needsAlert&&alerts.includes('details')?'field-highlight':''}" style="font-size:12px;color:#ddd;">${(p.package_details||"-").replace(/\b(skid|pallet)\b/gi, '<span class="heavy-word">$&</span>')}</div>
               </div>
               <div class="card-label">${botL}</div>
               <div class="bold ${needsAlert&&alerts.includes('dropName')?'field-highlight':''}" style="color:#bbb;font-size:13px;">${botC||'N/A'}</div>
               <div class="drop-value ${needsAlert&&alerts.includes('dest')?'field-highlight':''}">${botA}</div>
               ${p.po_number ? `<div id="po-container-${id}" onclick="enterPoEdit(event,'${id}','${p.po_number.replace(/'/g,"\\'")}')" class="pointer bold" style="color:#aaa;font-size:13px;margin-top:4px;">PO: <span class="${needsAlert&&alerts.includes('po')?'field-highlight':''}" style="color:var(--accent);">${p.po_number}</span></div>` : ''}
               ${p.other_info ? `<div id="note-display-${id}" class="g-note ${edited?'notes-edited':''} ${needsAlert&&alerts.includes('notes')?'field-highlight':''}">${p.other_info.replace(/\[([^\]]+)\]:/g, '<span style="color:var(--update-blue);font-weight:900;">[$1]:</span>')}</div>` : ''}
               ${(p.phone||p.customer_phone) ? `<a href="tel:${p.phone||p.customer_phone}" class="black" style="display:block;margin-top:12px;color:#2196f3;font-size:18px;text-decoration:none;border-top:1px solid #333;padding-top:8px;" onclick="event.stopPropagation()">ðŸ“ž ${p.phone||p.customer_phone}</a>` : ''}
            </div>
            <div class="col center" style="width:75px; gap:6px;"> 
               <div class="pointer" onclick="toggleDriverNoteEdit(event,'${id}')" style="margin-bottom:5px;"><svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:var(--accent);"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></div>
               <div class="col center" style="margin-bottom:4px;padding-right:60px;"><div style="font-size:13px;font-weight:700;color:#FFB020;white-space:nowrap;">${new Date(p.timestamp).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</div><div style="font-size:9px;font-weight:600;color:#666;text-transform:uppercase;">${new Date(p.timestamp).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div></div>
               <button class="info-btn" onclick="dndJob('${id}','${(p.other_info||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'")}')">${isPick?"DNP":"DND"}</button>
               <button class="done-btn" onclick="markDone('${id}')">DONE</button>
            </div>
          </div><div id="driver-note-display-${id}"></div>`;
        feed.appendChild(card); if (observer) observer.observe(card);
      }
    });

    updateNewStopsCountUI(); ctr.innerText = `${uniqueStops.size} STOP${uniqueStops.size!==1?'S':''}`;
    if (feed.classList.contains('overlay-active') && !feed.querySelector('.active-card[style="display: flex;"]')) closeJobCard();
    if (pCount === 0) {
        const compl = Object.values(globalJobs).filter(j=>j.assigned_to===currentDriver&&j.status==='completed'&&(j.completed_at||0)>=today).sort((a,b)=>b.completed_at-a.completed_at);
        let h = `<div style="padding:20px;text-align:center;border-bottom:1px solid #333;"><div class="black" style="font-size:16px;color:var(--accent);letter-spacing:1px;">DAILY PERFORMANCE</div><div style="font-size:48px;font-weight:900;margin:10px 0;line-height:1;">${compl.length}</div><div style="font-size:10px;font-weight:700;color:#666;">STOPS COMPLETED</div></div><div style="padding:15px;">`;
        if(!compl.length) h += `<div class="bold" style="text-align:center;color:#555;margin-top:20px;">READY FOR DISPATCH</div>`;
        else compl.forEach(j => {
             const c = j.jobType==='pickup'?'#ff9800':'#4caf50';
             h += `<div style="background:var(--bg-panel);border:1px solid var(--border-soft);border-radius:8px;padding:12px;margin-bottom:10px;"><div class="sb row mb-1"><span class="black uc" style="color:${c};font-size:10px;">${j.jobType}</span><span style="color:#888;font-size:11px;font-weight:700;">${new Date(j.completed_at).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</span></div><div class="black" style="font-size:13px;line-height:1.2;">${j.jobType==='pickup'?j.name:j.delivery_name}</div><div style="color:#aaa;font-size:12px;margin-top:2px;">${j.jobType==='pickup'?j.pickup_location:j.destination}</div>${j.po_number?`<div style="color:var(--accent);font-size:11px;margin-top:2px;">PO: ${j.po_number}</div>`:''}</div>`;
        });
        document.getElementById('mini-map-list').innerHTML = h + `</div><div style="height:60px;"></div>`;
        document.getElementById('mini-map-list').style.display = 'block';
    }
  }

  function markDone(id) {
    if(!confirm("Complete?")) return;
    const c = document.getElementById(`card-${id}`); if(c) c.style.transform = "scale(0.9) translateX(-20px)"; closeJobCard();
    sessionStorage.setItem('last_completed_job', id);
    setTimeout(() => db.ref(globalJobs[id].jobType==='pickup'?'pickups':'dropoffs').child(id).update({ status: 'completed', completed_at: Date.now() }), 500); 
  }

  function getNavUrl(a, c) { return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(a+', '+c)}&travelmode=driving`; }
  setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}), 1000);
  document.addEventListener('click', e => { if(e.target.id?.startsWith('note-display-')) { e.stopPropagation(); const id = e.target.id.split('-').pop(); db.ref(`${globalJobs[id].jobType==='pickup'?'pickups':'dropoffs'}/${id}/other_info`).once('value', s => enterNoteEdit(id, s.val()||"")); } });

  let defP;
  window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); defP = e; document.getElementById('install-btn').classList.remove('d-none'); });
  async function installPWA() { if (defP) { defP.prompt(); const { outcome } = await defP.userChoice; if (outcome === 'accepted') document.getElementById('install-btn').classList.add('d-none'); defP = null; } }
  if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  
  let tS = 0; const fUi = document.getElementById('live-feed');
  fUi.addEventListener('touchstart', e => tS = e.changedTouches[0].screenX, {passive: true});
  fUi.addEventListener('touchend', e => { if(e.changedTouches[0].screenX > tS + 75) closeJobCard(); }, {passive: true});
</script>
</body>
</html>
