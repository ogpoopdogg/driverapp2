<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Driver Mode | E&C Dispatch</title>
  <style>
    :root {
      --accent: #ffcc00;
      --queue-orange: #ff9800;
      --card-bg: #1e1e1e;
      --active-green: #4caf50;
      --review-blue: #2196f3;
      --decline-red: #f44336;
      --update-blue: #00d4ff;
    }
    * { box-sizing: border-box; }
    
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background: #050505; color: #e0e0e0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; }
    
    /* --- SPLIT SCREEN LAYOUT --- */
    #map-container {
      height: 40vh;
      width: 100%;
      position: relative;
      background: #222;
      z-index: 10;
      border-bottom: 2px solid var(--accent);
    }
    
    #map {
      height: 100%;
      width: 100%;
    }

    #main-container { 
      display: flex; 
      flex-direction: column; 
      height: 60vh; 
      width: 100%; 
      overflow: hidden; 
      background: #050505; 
      position: relative;
    }
    
    #live-feed { 
      flex: 1; 
      padding: 12px; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      padding-bottom: 80px; /* Space for Nav Bar */
    }

    /* --- OVERLAYS --- */
    #rerouting-banner {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color: var(--update-blue);
      border: 1px solid var(--update-blue); padding: 8px 16px; border-radius: 20px;
      font-weight: 900; font-size: 12px; z-index: 100;
      display: none; box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
      animation: pulse-blue 1s infinite alternate;
    }

    #nav-controls {
      position: absolute; bottom: 20px; right: 20px;
      z-index: 50; display: flex; gap: 10px;
    }

    .nav-btn {
      background: var(--active-green); color: #fff; border: none;
      padding: 10px 20px; border-radius: 50px; font-weight: 800;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer;
      text-transform: uppercase; font-size: 14px;
    }
    
    .recenter-btn {
        background: #333; color: #fff; width: 40px; height: 40px;
        border-radius: 50%; border: 1px solid #555;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; cursor: pointer;
    }

    /* --- CARD STYLES --- */
    .active-card { 
      background: var(--card-bg); padding: 10px 14px; border-radius: 12px; 
      border: 1px solid #333; width: 100%; display: flex; flex-direction: column; 
      position: relative; transition: all 0.3s;
    }

    .seq-number {
        position: absolute; top: -10px; left: -10px;
        width: 28px; height: 28px; background: #fff; color: #000;
        border-radius: 50%; font-weight: 900; font-size: 14px;
        display: flex; align-items: center; justify-content: center;
        border: 2px solid var(--accent); z-index: 20;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .card-layout { display: flex; justify-content: space-between; gap: 8px; margin-top: 5px; }
    .address-side { flex: 1; display: flex; flex-direction: column; }
    
    .tech-info { font-size: 16px; font-weight: 700; color: #eee; text-transform: uppercase; line-height: 1.2; margin-bottom: 2px; }
    .addr-text { font-size: 14px; color: #bbb; margin-bottom: 4px; }
    .type-badge { font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; display: inline-block; margin-bottom: 4px; color: #000; }

    .card-action-row { display: flex; gap: 10px; margin-top: 8px; }
    .action-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 14px; }
    .btn-done { background: linear-gradient(135deg, var(--active-green), #388e3c); color: #fff; }
    .btn-dnd { background: transparent; border: 1px solid #555; color: #888; }

    /* --- ANIMATIONS --- */
    @keyframes pulse-blue { from { opacity: 0.7; } to { opacity: 1; } }
    .pulse-gps { animation: pulse-gps 2s infinite; }
    @keyframes pulse-gps { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }

    /* Login & Utility */
    #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-box { background: #111; padding: 30px; border: 1px solid #333; text-align: center; border-radius: 12px; }
    .login-input { padding: 10px; width: 100%; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color:var(--accent);">DRIVER MODE</h2>
        <input type="text" id="login-user" class="login-input" placeholder="Driver Name">
        <input type="password" id="login-pin" class="login-input" placeholder="PIN">
        <button onclick="attemptLogin()" class="action-btn" style="background:var(--accent); color:#000;">START SHIFT</button>
    </div>
</div>

<div id="map-container">
    <div id="rerouting-banner">REROUTING...</div>
    <div id="map"></div>
    <div id="nav-controls">
        <div class="recenter-btn" onclick="centerOnDriver()">‚åñ</div>
        <button id="nav-btn" class="nav-btn" onclick="toggleNavigation()">START NAV</button>
    </div>
</div>

<div id="main-container">
    <div style="padding: 8px 12px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
        <span id="driver-header" style="color:var(--accent); font-weight:800; text-transform:uppercase;">OFFLINE</span>
        <span id="stop-counter" style="color:#666; font-size:12px; font-weight:700;">0 STOPS</span>
    </div>
    <div id="live-feed"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDltbEbiqlyQjyaGth0AzIkfLpOYr96YeQ&libraries=places,geometry&callback=initMap" async defer></script>

<script>
  /* --- CONFIG & STATE --- */
  const GOOGLE_KEY = "AIzaSyDltbEbiqlyQjyaGth0AzIkfLpOYr96YeQ";
  const SHOP_ADDRESS = "1604 Moreland Ave, Brandon MB";
  
  let map, directionsService, directionsRenderer;
  let driverMarker = null;
  let mapMarkers = [];
  let routePath = null;
  
  let globalJobs = {}; // Raw from Firebase
  let optimizedOrder = []; // Array of Job IDs in optimized order
  let currentDriver = localStorage.getItem('ec_driver_name');
  
  let isNavigating = false;
  let rerouteTimer = null;
  let lastGps = null;
  
  // Firebase Setup
  firebase.initializeApp({
    apiKey: "AIzaSyAKmgoXA4m3cRTmxJq4aUyva5SVvFbTNqg",
    authDomain: "eandccourier-36fcc.firebaseapp.com",
    databaseURL: "https://eandccourier-36fcc-default-rtdb.firebaseio.com",
    projectId: "eandccourier-36fcc"
  });
  const db = firebase.database();
  firebase.auth().signInAnonymously();

  /* --- MAP INITIALIZATION --- */
  function initMap() {
    const brandon = { lat: 49.8485, lng: -99.9501 };
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 13,
      center: brandon,
      disableDefaultUI: true, // Clean look
      styles: [
        { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
        { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
        { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
        { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] }
      ]
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      map: map,
      suppressMarkers: true, // We use custom pins
      preserveViewport: true,
      polylineOptions: { strokeColor: "#00d4ff", strokeWeight: 6, strokeOpacity: 0.8 }
    });

    // Custom Driver "Puck" Icon (Blue Arrow)
    const puckIcon = {
        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
        scale: 6,
        fillColor: "#4285F4",
        fillOpacity: 1,
        strokeWeight: 2,
        strokeColor: "white",
        rotation: 0
    };
    
    driverMarker = new google.maps.Marker({
        map: map,
        icon: puckIcon,
        zIndex: 999
    });
    
    startLocationTracking();
  }

  /* --- DATA HANDLING --- */
  function fetchJobs() {
    db.ref("pickups").on("value", s => mergeJobs(s.val(), 'pickup'));
    db.ref("dropoffs").on("value", s => mergeJobs(s.val(), 'delivery'));
  }

  function mergeJobs(data, type) {
    if(!data) return;
    Object.entries(data).forEach(([key, val]) => {
        if(val.assigned_to === currentDriver && val.status === 'pending') {
            const isNew = !globalJobs[key];
            globalJobs[key] = { ...val, jobType: type, id: key };
            
            // Trigger auto-route only on NEW jobs
            if(isNew) triggerAutoRoute();
        } else if(globalJobs[key] && (val.status !== 'pending' || val.assigned_to !== currentDriver)) {
            // Remove completed/reassigned jobs
            delete globalJobs[key];
            renderList(); // Immediate UI update for removals
        }
    });
    if(Object.keys(globalJobs).length > 0 && optimizedOrder.length === 0) {
        // First load, no order yet -> trigger route
        triggerAutoRoute();
    } else {
        renderList(); // Just update UI
    }
  }

  /* --- SMART AUTO-ROUTE LOGIC --- */
  function triggerAutoRoute() {
    const banner = document.getElementById("rerouting-banner");
    banner.style.display = "block";
    
    // Debounce: Wait 5 seconds after last trigger
    if(rerouteTimer) clearTimeout(rerouteTimer);
    
    rerouteTimer = setTimeout(() => {
        calculateOptimalRoute().then(() => {
            banner.style.display = "none";
            renderList();
            drawMapPins();
            if(isNavigating) drawRoutePolyline(); // Refresh line if Nav is active
        });
    }, 5000);
  }

  async function calculateOptimalRoute() {
    const jobs = Object.values(globalJobs);
    if(jobs.length === 0) return;

    // Use current GPS if available, else Shop
    const origin = lastGps ? 
        { location: { latLng: { latitude: lastGps.lat, longitude: lastGps.lng } } } :
        { address: SHOP_ADDRESS };

    const intermediates = jobs.map(j => ({
        address: j.jobType === 'pickup' ? 
            `${j.pickup_location}, ${j.city||''}` : 
            `${j.destination}, ${j.city||''}`
    }));

    try {
        const response = await fetch("https://routes.googleapis.com/directions/v2:computeRoutes", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Goog-Api-Key": GOOGLE_KEY,
                "X-Goog-FieldMask": "routes.optimizedIntermediateWaypointIndex"
            },
            body: JSON.stringify({
                origin: origin,
                destination: { address: SHOP_ADDRESS }, // Loop back to shop or make generic
                intermediates: intermediates,
                travelMode: "DRIVE",
                optimizeWaypointOrder: true
            })
        });
        
        const result = await response.json();
        
        if(result.routes && result.routes[0].optimizedIntermediateWaypointIndex) {
            const order = result.routes[0].optimizedIntermediateWaypointIndex;
            optimizedOrder = order.map(idx => jobs[idx].id);
        } else {
            // Fallback: Default array order
            optimizedOrder = jobs.map(j => j.id);
        }

    } catch(e) {
        console.error("Routing failed", e);
        optimizedOrder = jobs.map(j => j.id);
    }
  }

  /* --- RENDERING --- */
  function renderList() {
    const feed = document.getElementById("live-feed");
    feed.innerHTML = "";
    document.getElementById("stop-counter").innerText = `${optimizedOrder.length} STOPS`;

    // Render in OPTIMIZED order
    optimizedOrder.forEach((id, index) => {
        const job = globalJobs[id];
        if(!job) return;

        const isPickup = job.jobType === 'pickup';
        const badgeColor = isPickup ? 'var(--queue-orange)' : 'var(--active-green)';
        const addr = isPickup ? job.pickup_location : job.destination;
        const name = isPickup ? job.name : job.delivery_name;
        
        const card = document.createElement("div");
        card.className = "active-card";
        card.onclick = () => focusMapOnJob(id); // Click card to zoom map
        
        card.innerHTML = `
            <div class="seq-number" style="border-color:${badgeColor}">${index + 1}</div>
            <div class="card-layout">
                <div class="address-side" style="margin-left: 15px;">
                   <div class="type-badge" style="background:${badgeColor}">${isPickup ? "PICK UP" : "DELIVER"}</div>
                   <div class="tech-info">${name}</div>
                   <div class="addr-text">${addr}</div>
                   <div style="font-size:12px; color:#666;">${job.package_details || ''}</div>
                </div>
            </div>
            <div class="card-action-row">
                <button class="action-btn btn-dnd" onclick="event.stopPropagation(); dndJob('${id}')">SKIP</button>
                <button class="action-btn btn-done" onclick="event.stopPropagation(); completeJob('${id}')">COMPLETE</button>
            </div>
        `;
        feed.appendChild(card);
    });
  }

  function drawMapPins() {
    // Clear old markers
    mapMarkers.forEach(m => m.setMap(null));
    mapMarkers = [];

    const bounds = new google.maps.LatLngBounds();

    optimizedOrder.forEach((id, index) => {
        const job = globalJobs[id];
        if(!job) return;

        const isPickup = job.jobType === 'pickup';
        const color = isPickup ? "FE9800" : "4CAF50"; // Orange / Green Hex (no hash)
        
        // Use Google Charts API for dynamic numbered pins
        const iconUrl = `https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=${index + 1}|${color}|000000`;
        
        // Geocode addresses lazily (Ideally we store Lat/Lng in DB, but for now we assume string)
        // For this demo, we use a crude geocoder or existing coords if available
        // Note: Production should store Lat/Lng. Here we rely on Google Directions to draw the line
        // We will just try to plot if we have coords, otherwise they appear when route is drawn.
        
        // Simulating marker placement requires LatLng. 
        // If your DB has lat/lng, use it. If not, we rely on the directionsRenderer line mainly.
        // However, for pins to show UP FRONT, we need coordinates.
        // I will assume for this view that the DirectionsRenderer creates the visual path, 
        // and we overlay markers if we can.
    });
  }

  function focusMapOnJob(id) {
    // In a real app with LatLng stored: map.setCenter(job.latLng); map.setZoom(16);
    // Without stored LatLng, we rely on the route overview.
    alert("Map centering requires Lat/Lng in database. \n(Start Navigation to see route line)");
  }

  /* --- NAVIGATION MODE --- */
  function toggleNavigation() {
    const btn = document.getElementById("nav-btn");
    isNavigating = !isNavigating;
    
    if(isNavigating) {
        btn.innerText = "STOP NAV";
        btn.style.background = "var(--decline-red)";
        drawRoutePolyline();
        map.setZoom(18);
        map.setTilt(45); // 3D Tilt
    } else {
        btn.innerText = "START NAV";
        btn.style.background = "var(--active-green)";
        directionsRenderer.setDirections({routes: []}); // Clear line
        map.setTilt(0);
        map.setZoom(13);
    }
  }

  function drawRoutePolyline() {
    if(optimizedOrder.length === 0) return;
    
    const waypoints = optimizedOrder.map(id => {
        const j = globalJobs[id];
        const addr = j.jobType === 'pickup' ? j.pickup_location : j.destination;
        return { location: `${addr}, ${j.city||'Brandon'}`, stopover: true };
    });

    const request = {
        origin: lastGps ? { lat: lastGps.lat, lng: lastGps.lng } : SHOP_ADDRESS,
        destination: SHOP_ADDRESS,
        waypoints: waypoints,
        optimizeWaypoints: false, // Already optimized
        travelMode: 'DRIVING'
    };

    directionsService.route(request, (result, status) => {
        if (status === 'OK') {
            directionsRenderer.setDirections(result);
            
            // Add Numbered Markers manually on top of the line
            mapMarkers.forEach(m => m.setMap(null));
            mapMarkers = [];
            
            const legs = result.routes[0].legs;
            // Leg 0 is Start -> Stop 1. The 'end_location' of Leg 0 is Stop 1.
            legs.forEach((leg, i) => {
                if(i < optimizedOrder.length) {
                   const isPickup = globalJobs[optimizedOrder[i]].jobType === 'pickup';
                   const color = isPickup ? "FE9800" : "4CAF50";
                   const marker = new google.maps.Marker({
                       position: leg.end_location,
                       map: map,
                       icon: `https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=${i+1}|${color}|000000`,
                       zIndex: 100
                   });
                   mapMarkers.push(marker);
                }
            });

        } else {
            console.error('Directions request failed due to ' + status);
        }
    });
  }

  /* --- GPS & TRACKING --- */
  function startLocationTracking() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            lastGps = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            const latLng = new google.maps.LatLng(lastGps.lat, lastGps.lng);
            
            driverMarker.setPosition(latLng);
            
            // If navigating, follow the puck
            if(isNavigating) {
                map.setCenter(latLng);
                // Rotate puck if heading exists
                if(pos.coords.heading) {
                    const icon = driverMarker.getIcon();
                    icon.rotation = pos.coords.heading;
                    driverMarker.setIcon(icon);
                }
            }
            
            // Update DB for dispatch visibility
            if(currentDriver) {
                 db.ref(`driver_locations/${currentDriver}`).update({
                    lat: lastGps.lat,
                    lng: lastGps.lng,
                    heading: pos.coords.heading || 0,
                    last_seen: Date.now()
                });
            }

        }, err => console.warn(err), { enableHighAccuracy: true });
    }
  }

  function centerOnDriver() {
      if(lastGps) {
          map.setCenter({ lat: lastGps.lat, lng: lastGps.lng });
          map.setZoom(16);
      }
  }

  /* --- JOB ACTIONS --- */
  function completeJob(id) {
    if(confirm("Mark Complete?")) {
        const job = globalJobs[id];
        const ref = job.jobType === 'pickup' ? 'pickups' : 'dropoffs';
        db.ref(`${ref}/${id}`).update({ status: 'completed', completed_at: Date.now() });
        // UI will update automatically via listener
    }
  }

  function dndJob(id) {
    const reason = prompt("Reason for skipping?");
    if(reason) {
        const job = globalJobs[id];
        const ref = job.jobType === 'pickup' ? 'pickups' : 'dropoffs';
        db.ref(`${ref}/${id}`).update({ 
            status: 'pending', 
            assigned_to: '', // Unassign
            other_info: `${job.other_info || ''} | SKIP: ${reason}` 
        });
    }
  }

  /* --- LOGIN LOGIC --- */
  function attemptLogin() {
    const name = document.getElementById('login-user').value.trim();
    const pin = document.getElementById('login-pin').value;
    
    if(!name || !pin) return alert("Enter Name and PIN");

    db.ref(`driver_secrets/${name}`).once('value', s => {
        if(s.val() == pin) {
            localStorage.setItem('ec_driver_name', name);
            currentDriver = name;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('driver-header').innerText = currentDriver;
            fetchJobs();
        } else {
            alert("Invalid Login");
        }
    });
  }

  // Auto-login check
  if(currentDriver) {
      document.getElementById('login-overlay').classList.add('hidden');
      document.getElementById('driver-header').innerText = currentDriver;
      fetchJobs();
  }

</script>
</body>
</html>
